import sys
import uuid
from pathlib import Path

from pyipp.enums import IppOperation, IppFinishing
from requests import Session, Response

sys.path.append(str(Path(__file__).absolute().parent.parent / 'service'))

from ipp.ipp_message import IppMessage


class ServiceSession:
    def __init__(self, url: str) -> None:
        self.url = url.rstrip('/')
        self.session = Session()

    def get(self, url: str, **kwargs) -> Response:
        return self.session.get(self.url + url, **kwargs)

    def post(self, url: str, *args, **kwargs) -> Response:
        return self.session.post(self.url + url, *args, **kwargs)

    def login(self, username: str, password: str) -> bool:
        response = self.post('/login', {'name': username, 'password': password})
        return f'Welcome, {username}' in response.text

    def signup(self, username: str, password: str) -> bool:
        response = self.post('/signup', {'name': username, 'password': password})
        return f'Welcome, {username}' in response.text

    def rent_printer(self, name: str, templates: list[str], upgrades: list[str], **kwargs) -> Response:
        data = [('name', name)]
        for tmpl in templates:
            data.append((f'template-{tmpl}', '1'))
        for upgrade in upgrades:
            data.append(('upgrades', upgrade))
        response = self.post('/rent-a-printer', data, **kwargs)
        assert f'Your printer is active' in response.text, 'Could not add printer'
        return response


class MyIppClient:
    def __init__(self, url: str) -> None:
        self.url = url
        self.http_url = url.replace('ipp://', 'http://').replace('ipps://', 'https://')
        self.session = Session()
        self.next_request_id = 1
        self.default_attrs = {
            'attributes-charset': 'utf-8',
            'attributes-natural-language': 'en-us',
            'printer-uri': self.url,
            "requesting-user-name": "saarsec",
        }

    def request(self, req: IppMessage) -> IppMessage:
        req.request_id = self.next_request_id
        self.next_request_id += 1

        for k, v in self.default_attrs.items():
            if k not in req.operation_attributes:
                req.operation_attributes[k] = v

        http_response = self.session.post(self.http_url, data=req.encode(), headers={'content-type': 'application/ipp'})
        assert http_response.status_code == 200
        return IppMessage.decode(http_response.content)

    def print_job(self, doctype: str, docname: str, document: bytes):
        return self.request(IppMessage(
            status_code=IppOperation.PRINT_JOB.value,
            operation_attributes={
                'job-name': docname,
                'document-name': docname,
                'document-format': doctype,
                'job-impressions': 1,
                'job-media-sheets': 1,
            },
            jobs=[{
                # 'ColorModel': 'Gray',
                'document-name-supplied': docname,
                # 'Duplex': 'None',
                'finishings': IppFinishing.NONE.value,
                'job-cancel-after': 10800,
                'job-originating-host-name': 'localhost',
                'job-originating-user-name': 'root',
                'job-priority': 50,
                'job-sheets': ['none'],
                'job-uuid': 'urn:uuid:' + str(uuid.uuid4()),
                'media': 'unknown',
                'number-up': 1,
                'orientation-requested': 0,
                'output-bin': 'face-down',
                'output-format': 'pdf',
                'print-color-mode': 'monochrome',
                'print-quality': 0,
                'printer-resolution': (300, 300, 3),
                # 'Resolution': '600dpi',
                'sides': 'one-sided'
            }],
            data=document
        ))
